# =============================================================================
# EcoEstudiante Gateway - Perfil Docker
# =============================================================================
# Este perfil se activa con: SPRING_PROFILES_ACTIVE=docker
# Configuración optimizada para ejecución en contenedores
# =============================================================================

server:
  port: 8080

spring:
  cloud:
    gateway:
      routes:
        # Servicio de Autenticación
        - id: auth-service
          uri: ${BACKEND_API_URL:http://api:8080}
          predicates:
            - Path=/api/v1/auth/**,/api/auth/**
          metadata:
            service-name: auth-service

        # Servicio de Cálculo CO₂e
        - id: calc-service
          uri: ${BACKEND_API_URL:http://api:8080}
          predicates:
            - Path=/api/v1/calc/**
          metadata:
            service-name: calc-service

        # Servicio de Gamificación
        - id: gam-service
          uri: ${BACKEND_API_URL:http://api:8080}
          predicates:
            - Path=/api/v1/gam/**
          metadata:
            service-name: gamification-service

        # Servicio de Reportes
        - id: reports-service
          uri: ${BACKEND_API_URL:http://api:8080}
          predicates:
            - Path=/api/v1/reports/**
          metadata:
            service-name: reports-service

  # Redis para rate limiting (Fase 4)
  data:
    redis:
      host: ${SPRING_REDIS_HOST:redis}
      port: ${SPRING_REDIS_PORT:6379}
      timeout: 2000ms

  # R2DBC para auto-create usuarios Auth0
  # Usa el mismo PostgreSQL que el backend
  r2dbc:
    url: r2dbc:postgresql://${DB_HOST:postgres}:${DB_PORT:5432}/${DB_NAME:ecoestudiante}
    username: ${DB_USERNAME:eco}
    password: ${DB_PASSWORD:eco}
    pool:
      initial-size: 5
      max-size: 10
      max-idle-time: 30m

  # Auth0 Configuration (opcional - autenticación dual)
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${AUTH0_ISSUER_BASE_URL:}
          audience: ${AUTH0_AUDIENCE:https://api.ecoestudiante.com}

# JWT Configuration
jwt:
  secret: ${JWT_SECRET:YourSecretKeyShouldBeAtLeast256BitsLongForHS512AlgorithmToWorkProperlyAndSecurely}

# CORS Configuration
cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:3000}

# Actuator (health checks para Docker/K8s)
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      probes:
        enabled: true
      show-details: always
  health:
    livenessState:
      enabled: true
    readinessState:
      enabled: true

# Logging optimizado para contenedores
logging:
  level:
    root: INFO
    com.ecoestudiante: INFO
    org.springframework: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
