<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing de Analytics - EcoEstudiante</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .test-button:active {
            transform: translateY(0);
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            max-height: 200px;
            overflow-y: auto;
        }

        .result pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 13px;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status.success {
            background: #10b981;
            color: white;
        }

        .status.error {
            background: #ef4444;
            color: white;
        }

        .status.testing {
            background: #f59e0b;
            color: white;
        }

        .instructions {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .instructions h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #856404;
        }

        .instructions li {
            margin: 8px 0;
        }

        .open-analytics {
            display: block;
            width: 100%;
            max-width: 400px;
            margin: 30px auto;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-align: center;
            text-decoration: none;
        }

        .open-analytics:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Testing de Analytics</h1>
        <p class="subtitle">Pruebas automatizadas de filtros y gr√°ficos</p>

        <div class="instructions">
            <h3>üìã Instrucciones de Testing</h3>
            <ol>
                <li><strong>Primero</strong>: Haz login en EcoEstudiante con el usuario <code>HECTOR</code></li>
                <li><strong>Segundo</strong>: Abre la p√°gina de Analytics haciendo click en el bot√≥n verde abajo</li>
                <li><strong>Tercero</strong>: Prueba los filtros manualmente en la p√°gina de Analytics</li>
                <li><strong>Cuarto</strong>: Vuelve a esta p√°gina y ejecuta las pruebas autom√°ticas</li>
            </ol>
        </div>

        <a href="http://localhost:3000/analytics" target="_blank" class="open-analytics">
            üìä Abrir Analytics en Nueva Pesta√±a
        </a>

        <!-- Test 1: Filtro de Categor√≠as -->
        <div class="test-section">
            <h2>üîç Test 1: Filtros de Categor√≠as Individuales</h2>
            <p>Prueba cada categor√≠a por separado para verificar que los datos cambien.</p>
            <button class="test-button" onclick="testCategory('electricidad')">‚ö° Solo Electricidad</button>
            <button class="test-button" onclick="testCategory('transporte')">üöó Solo Transporte</button>
            <button class="test-button" onclick="testCategory('residuos')">‚ôªÔ∏è Solo Residuos</button>
            <div id="test1-result" class="result" style="display:none;">
                <pre id="test1-data"></pre>
            </div>
        </div>

        <!-- Test 2: Combinaciones de Categor√≠as -->
        <div class="test-section">
            <h2>üîó Test 2: Combinaciones de Categor√≠as</h2>
            <p>Prueba m√∫ltiples categor√≠as simult√°neamente.</p>
            <button class="test-button" onclick="testCombination(['electricidad', 'transporte'])">‚ö°üöó Electricidad + Transporte</button>
            <button class="test-button" onclick="testCombination(['transporte', 'residuos'])">üöó‚ôªÔ∏è Transporte + Residuos</button>
            <button class="test-button" onclick="testCombination(['electricidad', 'residuos'])">‚ö°‚ôªÔ∏è Electricidad + Residuos</button>
            <button class="test-button" onclick="testCombination(['electricidad', 'transporte', 'residuos'])">üåç Todas las Categor√≠as</button>
            <div id="test2-result" class="result" style="display:none;">
                <pre id="test2-data"></pre>
            </div>
        </div>

        <!-- Test 3: Filtros Temporales -->
        <div class="test-section">
            <h2>üìÖ Test 3: Filtros Temporales</h2>
            <p>Prueba diferentes rangos de tiempo.</p>
            <button class="test-button" onclick="testTimeSeries('month', 1)">üìä √öltimo Mes</button>
            <button class="test-button" onclick="testTimeSeries('month', 3)">üìä √öltimos 3 Meses</button>
            <button class="test-button" onclick="testTimeSeries('month', 6)">üìä √öltimos 6 Meses</button>
            <button class="test-button" onclick="testTimeSeries('month', 12)">üìä √öltimos 12 Meses</button>
            <div id="test3-result" class="result" style="display:none;">
                <pre id="test3-data"></pre>
            </div>
        </div>

        <!-- Test 4: Filtros Combinados Avanzados -->
        <div class="test-section">
            <h2>üéØ Test 4: Filtros Combinados Avanzados</h2>
            <p>Combina categor√≠as con rangos temporales.</p>
            <button class="test-button" onclick="testAdvanced('electricidad', 6)">‚ö° Electricidad (6 meses)</button>
            <button class="test-button" onclick="testAdvanced('transporte', 3)">üöó Transporte (3 meses)</button>
            <button class="test-button" onclick="testAdvancedMultiple(['electricidad', 'transporte'], 12)">‚ö°üöó M√∫ltiple (12 meses)</button>
            <div id="test4-result" class="result" style="display:none;">
                <pre id="test4-data"></pre>
            </div>
        </div>

        <!-- Test 5: Resumen General -->
        <div class="test-section">
            <h2>üìä Test 5: Resumen General de Datos</h2>
            <p>Verifica el resumen de estad√≠sticas generales.</p>
            <button class="test-button" onclick="testSummary()">üìà Ver Resumen General</button>
            <div id="test5-result" class="result" style="display:none;">
                <pre id="test5-data"></pre>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:18080/api/v1/calc/stats';
        const USER_ID = '0337bc65-4e22-4233-8f71-ce1855154b11';

        // Generar token JWT simple (para testing)
        const TOKEN = 'eyJhbGciOiJIUzUxMiJ9.eyJ0eXBlIjoiYWNjZXNzIiwidXNlcklkIjoiMDMzN2JjNjUtNGUyMi00MjMzLThmNzEtY2UxODU1MTU0YjExIiwic3ViIjoiSEVDVE9SIiwiaWF0IjoxNzMyODUyMDAwLCJleHAiOjk5OTk5OTk5OTl9.test';

        async function makeRequest(url) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${TOKEN}`
                    }
                });
                return await response.json();
            } catch (error) {
                return { error: error.message };
            }
        }

        async function testCategory(category) {
            updateStatus('test1', 'testing', `Probando ${category}...`);
            const url = `${API_BASE}/by-category?categories=${category}`;
            const data = await makeRequest(url);

            if (data.error) {
                updateStatus('test1', 'error', 'Error en la prueba');
                displayResult('test1', data);
            } else {
                const summary = data.categories.map(cat =>
                    `${cat.category}: ${cat.recordCount} registros, ${cat.totalKgCO2e.toFixed(2)} kg CO2e (${cat.percentage.toFixed(1)}%)`
                ).join('\n');
                updateStatus('test1', 'success', 'Prueba exitosa');
                displayResult('test1', `‚úÖ FILTRO: ${category.toUpperCase()}\n\n${summary}\n\nTotal: ${data.totalKgCO2e.toFixed(2)} kg CO2e`);
            }
        }

        async function testCombination(categories) {
            updateStatus('test2', 'testing', 'Probando combinaci√≥n...');
            const params = categories.map(cat => `categories=${cat}`).join('&');
            const url = `${API_BASE}/by-category?${params}`;
            const data = await makeRequest(url);

            if (data.error) {
                updateStatus('test2', 'error', 'Error en la prueba');
                displayResult('test2', data);
            } else {
                const summary = data.categories.map(cat =>
                    `${cat.category}: ${cat.recordCount} registros, ${cat.totalKgCO2e.toFixed(2)} kg CO2e (${cat.percentage.toFixed(1)}%)`
                ).join('\n');
                updateStatus('test2', 'success', 'Prueba exitosa');
                displayResult('test2', `‚úÖ COMBINACI√ìN: ${categories.join(' + ').toUpperCase()}\n\n${summary}\n\nTotal: ${data.totalKgCO2e.toFixed(2)} kg CO2e\nCategor√≠as combinadas: ${data.categories.length}`);
            }
        }

        async function testTimeSeries(groupBy, months) {
            updateStatus('test3', 'testing', `Probando ${months} meses...`);
            const url = `${API_BASE}/time-series?groupBy=${groupBy}&months=${months}`;
            const data = await makeRequest(url);

            if (data.error) {
                updateStatus('test3', 'error', 'Error en la prueba');
                displayResult('test3', data);
            } else {
                const points = data.data.map(point =>
                    `${point.period}: ${point.totalKgCO2e.toFixed(2)} kg CO2e (${point.recordCount} registros)`
                ).join('\n');
                updateStatus('test3', 'success', 'Prueba exitosa');
                displayResult('test3', `‚úÖ TIME SERIES: √öltimos ${months} meses\n\nPuntos de datos: ${data.data.length}\nTotal: ${data.totalKgCO2e.toFixed(2)} kg CO2e\n\n${points}`);
            }
        }

        async function testAdvanced(category, months) {
            updateStatus('test4', 'testing', 'Probando filtro combinado...');
            const url = `${API_BASE}/time-series?groupBy=month&months=${months}&categories=${category}`;
            const data = await makeRequest(url);

            if (data.error) {
                updateStatus('test4', 'error', 'Error en la prueba');
                displayResult('test4', data);
            } else {
                const points = data.data.slice(0, 5).map(point =>
                    `${point.period}: ${point.totalKgCO2e.toFixed(2)} kg CO2e`
                ).join('\n');
                updateStatus('test4', 'success', 'Prueba exitosa');
                displayResult('test4', `‚úÖ FILTRO AVANZADO: ${category.toUpperCase()} - ${months} meses\n\nPuntos: ${data.data.length}\nTotal: ${data.totalKgCO2e.toFixed(2)} kg CO2e\n\nPrimeros 5 periodos:\n${points}`);
            }
        }

        async function testAdvancedMultiple(categories, months) {
            updateStatus('test4', 'testing', 'Probando filtros m√∫ltiples...');
            const params = categories.map(cat => `categories=${cat}`).join('&');
            const url = `${API_BASE}/time-series?groupBy=month&months=${months}&${params}`;
            const data = await makeRequest(url);

            if (data.error) {
                updateStatus('test4', 'error', 'Error en la prueba');
                displayResult('test4', data);
            } else {
                updateStatus('test4', 'success', 'Prueba exitosa');
                displayResult('test4', `‚úÖ FILTROS M√öLTIPLES: ${categories.join(' + ').toUpperCase()}\n\nPeriodo: ${months} meses\nPuntos: ${data.data.length}\nTotal: ${data.totalKgCO2e.toFixed(2)} kg CO2e`);
            }
        }

        async function testSummary() {
            updateStatus('test5', 'testing', 'Obteniendo resumen...');
            const url = `${API_BASE}/summary`;
            const data = await makeRequest(url);

            if (data.error) {
                updateStatus('test5', 'error', 'Error en la prueba');
                displayResult('test5', data);
            } else {
                updateStatus('test5', 'success', 'Prueba exitosa');
                displayResult('test5', `‚úÖ RESUMEN GENERAL\n\nTotal registros: ${data.totalRecords}\nTotal emisiones: ${data.totalKgCO2e.toFixed(2)} kg CO2e\nEste mes: ${data.thisMonthKgCO2e.toFixed(2)} kg CO2e\nMes anterior: ${data.lastMonthKgCO2e.toFixed(2)} kg CO2e\nPromedio mensual: ${data.averagePerMonth.toFixed(2)} kg CO2e\n\nCalculado: ${new Date(data.calculatedAt).toLocaleString('es-ES')}`);
            }
        }

        function updateStatus(testId, status, message) {
            const section = document.querySelector(`#${testId}-result`).closest('.test-section');
            let statusEl = section.querySelector('.status');
            if (!statusEl) {
                statusEl = document.createElement('span');
                statusEl.className = 'status';
                section.querySelector('h2').appendChild(statusEl);
            }
            statusEl.className = `status ${status}`;
            statusEl.textContent = message;
        }

        function displayResult(testId, data) {
            const resultDiv = document.getElementById(`${testId}-result`);
            const dataDiv = document.getElementById(`${testId}-data`);

            if (typeof data === 'string') {
                dataDiv.textContent = data;
            } else {
                dataDiv.textContent = JSON.stringify(data, null, 2);
            }

            resultDiv.style.display = 'block';
        }
    </script>
</body>
</html>
